<Window x:Class="Vexa.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="clr-namespace:Vexa.Controls"
        xmlns:converters="clr-namespace:Vexa.Converters"
        xmlns:Models="clr-namespace:Vexa.Models"
        mc:Ignorable="d"
        Title="Vexa Station"
        Height="900"
        Width="1280"
        MinHeight="720"
        MinWidth="1100">
    <Window.Resources>
        <converters:FileNameConverter x:Key="FileNameConverter" />
        <converters:TrueToWeightConverter x:Key="TrueToWeightConverter" />
        <converters:BoolToBrushConverter x:Key="ActiveSegmentConverter"
                                         TrueBrush="#F5F5F5"
                                         FalseBrush="Transparent" />

        <Style x:Key="ControlButtonStyle" TargetType="Control">
            <Setter Property="Background" Value="White" />
            <Setter Property="Foreground" Value="{StaticResource InkBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="BorderBrush" Value="#E0E0E0" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="Margin" Value="2" />
            <EventSetter Event="ButtonBase.MouseRightButtonUp" Handler="OnButtonRightClick" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#F5F5F5" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ControlToggleButtonStyle" TargetType="ToggleButton" BasedOn="{StaticResource ControlButtonStyle}">
            <Style.Triggers>
                <Trigger Property="IsChecked" Value="True">
                    <Setter Property="Background" Value="#E0E0E0" />
                    <Setter Property="BorderBrush" Value="#4A90E2" />
                    <Setter Property="Foreground" Value="#4A90E2" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ShortcutBarStyle" TargetType="Border">
            <Setter Property="Background" Value="White" />
            <Setter Property="BorderBrush" Value="#DDDDDD" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="20" />
            <Setter Property="Padding" Value="12,6" />
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="15" ShadowDepth="2" Opacity="0.1" />
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid Background="#E8E8E8" AllowDrop="True" PreviewDragOver="OnDragOver" Drop="OnDrop">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" /> <!-- Header -->
            <RowDefinition Height="120" /> <!-- Waveform -->
            <RowDefinition Height="Auto" /> <!-- Toolbar -->
            <RowDefinition Height="*" />    <!-- Editor -->
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="{StaticResource HeaderBrush}" Padding="12,6">
            <StackPanel Orientation="Horizontal">
                <Border Background="#4A90E2" Width="32" Height="32" CornerRadius="4" Margin="0,0,12,0">
                    <TextBlock Text="ðŸŽ§" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" />
                </Border>
                <TextBlock Text="{Binding AudioPath}" VerticalAlignment="Center" Foreground="White" FontSize="16" FontStyle="Italic" Opacity="0.8" />
            </StackPanel>
        </Border>

        <!-- Waveform -->
        <Border Grid.Row="1" Background="White" BorderBrush="#DDDDDD" BorderThickness="0,1">
            <controls:WaveformControl WaveformData="{Binding WaveformData}" 
                                      CurrentPosition="{Binding AudioPosition, Mode=TwoWay}" 
                                      ZoomLevel="{Binding ZoomLevel}" />
        </Border>

        <!-- Toolbar -->
        <Border Grid.Row="2" Background="White" Padding="8,4" BorderBrush="#DDDDDD" BorderThickness="0,0,0,1">
            <Grid>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                    <Button Content="ðŸ“‚" Command="{Binding OpenAudioCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Open Audio File" Tag="{x:Static Models:InputAction.OpenAudio}" />
                    <Separator Width="1" Margin="8,4" Background="#EEEEEE" />
                    <Button Content="â–¶" Command="{Binding PlayPauseCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Play/Pause" Tag="{x:Static Models:InputAction.PlayPause}" />
                    <Button Content="â¸" Command="{Binding PlayPauseCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Pause" Tag="{x:Static Models:InputAction.PlayPause}" />
                    <Button Content="â®" Command="{Binding RewindCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Rewind" Tag="{x:Static Models:InputAction.Rewind}" />
                    <Button Content="âª" Command="{Binding RewindCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Back" Tag="{x:Static Models:InputAction.Rewind}" />
                    <Button Content="â©" Command="{Binding ForwardCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Forward" Tag="{x:Static Models:InputAction.Forward}" />
                    <Button Content="â­" Command="{Binding NextSegmentCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Next Segment" Tag="{x:Static Models:InputAction.NextSegment}" />
                    
                    <Separator Width="1" Margin="8,4" Background="#EEEEEE" />
                    
                    <TextBlock Text="ðŸ”ˆ" VerticalAlignment="Center" Margin="4,0" />
                    <Slider Value="{Binding Volume}" Minimum="0" Maximum="1" TickFrequency="0.1" IsSnapToTickEnabled="False" Width="100" Margin="4,0" />
                    
                    <Separator Width="1" Margin="8,4" Background="#EEEEEE" />
                    
                    <Button Content="ðŸ”„" Command="{Binding LoopSelectionCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Loop selection" Tag="{x:Static Models:InputAction.LoopSelection}" />
                    <Button Content="â†º" Command="{Binding LoopLastFiveSecondsCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Loop last 5s" Tag="{x:Static Models:InputAction.LoopLastFiveSeconds}" />
                    <Button Content="âš¡" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Auto-split" />
                    
                    <Separator Width="1" Margin="8,4" Background="#EEEEEE" />
                    
                    <Button Content="-" Command="{Binding ZoomOutCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Zoom out" Tag="{x:Static Models:InputAction.ZoomOut}" />
                    <Button Content="+" Command="{Binding ZoomInCommand}" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Zoom in" Tag="{x:Static Models:InputAction.ZoomIn}" />
                    <Button Content="ðŸ•" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Time View" />
                    <Button Content="ðŸ”" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="Search" />
                    <Button Content="AB" Style="{StaticResource ControlButtonStyle}" Width="32" ToolTip="AB Loop" />
                    
                    <Separator Width="1" Margin="8,4" Background="#EEEEEE" />
                    
                    <ToggleButton IsChecked="{Binding IsPlaylistVisible}" Content="ðŸ“‹" Style="{StaticResource ControlToggleButtonStyle}" Width="32" ToolTip="Toggle Playlist" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <TextBlock Text="ðŸ”ˆ" VerticalAlignment="Center" Margin="8,0" />
                    <TextBlock Text="Speed:" VerticalAlignment="Center" Foreground="#555555" Margin="4,0" />
                    <ComboBox SelectedValue="{Binding PlaybackSpeed}" Width="70" Margin="4,0">
                        <ComboBoxItem Content="0.5x" Tag="0.5" />
                        <ComboBoxItem Content="1.0x" Tag="1.0" />
                        <ComboBoxItem Content="1.2x" Tag="1.2" />
                        <ComboBoxItem Content="1.5x" Tag="1.5" />
                    </ComboBox>
                    <TextBlock Text="Time:" VerticalAlignment="Center" Foreground="#555555" Margin="8,0" />
                    <TextBlock Text="{Binding FormattedCurrentTime}" FontWeight="SemiBold" VerticalAlignment="Center" Width="45" />
                    
                    <TextBlock Text="Total:" VerticalAlignment="Center" Foreground="#555555" Margin="8,0" />
                    <TextBlock Text="{Binding FormattedTotalTime}" FontWeight="SemiBold" VerticalAlignment="Center" Width="45" />

                    <Button Content="Save" Command="{Binding SaveCommand}" Style="{StaticResource ActionButtonStyle}" Margin="12,0,0,0" ToolTip="Save (Ctrl+S)" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <Grid Grid.Row="3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Editor (Paper Style) -->
            <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" Padding="40">
                <Border Background="White" MaxWidth="800" MinHeight="900" CornerRadius="2" BorderBrush="#CCCCCC" BorderThickness="1"
                        MouseLeftButtonDown="OnPaperMouseDown" Padding="60">
                    <Border.Effect>
                        <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.1" />
                    </Border.Effect>
                    
                    <ItemsControl x:Name="SegmentsItemsControl" ItemsSource="{Binding Session.Segments}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{Binding IsActive, Converter={StaticResource ActiveSegmentConverter}}" Padding="4" Margin="0,0,0,2">
                                    <RichTextBox converters:RichTextBoxHelper.BoundText="{Binding Text, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                 BorderThickness="0" Background="Transparent" FontSize="15" Cursor="IBeam"
                                                 AcceptsReturn="True" AcceptsTab="True" SpellCheck.IsEnabled="True">
                                    </RichTextBox>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Border>
            </ScrollViewer>

            <!-- Playlist Sidebar -->
            <Border Grid.Column="1" Width="260" Background="#F8F8F8" BorderBrush="#DDDDDD" BorderThickness="1,0,0,0" Padding="12"
                    Visibility="{Binding IsPlaylistVisible, Converter={StaticResource BooleanToVisibilityConverter}}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <TextBlock Text="Audio Queue" FontSize="18" FontWeight="SemiBold" Foreground="#333333" Margin="0,0,0,12" />

                    <ListBox Grid.Row="1" ItemsSource="{Binding Playlist}" SelectedIndex="{Binding PlaylistIndex}"
                             Background="Transparent" BorderThickness="0" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{Binding Converter={StaticResource FileNameConverter}}" 
                                               TextTrimming="CharacterEllipsis" VerticalAlignment="Center"
                                               FontWeight="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}, Converter={StaticResource TrueToWeightConverter}}" />
                                    <Button Grid.Column="1" Content="âœ•" Command="{Binding DataContext.RemoveFromPlaylistCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}" Background="Transparent" BorderThickness="0" Foreground="#999999" Padding="4,0" />
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <Button Grid.Row="2" Content="Clear Queue" Command="{Binding ClearPlaylistCommand}" 
                            Style="{StaticResource ControlButtonStyle}" HorizontalAlignment="Stretch" Margin="0,12,0,0" />
                </Grid>
            </Border>
        </Grid>

        <Menu Grid.Row="0" Opacity="0" IsHitTestVisible="False">
            <MenuItem Header="_File">
                <MenuItem Header="Open Audio..." Command="{Binding OpenAudioCommand}" />
                <MenuItem Header="Open Session..." Command="{Binding OpenSessionCommand}" />
                <MenuItem Header="Save" Command="{Binding SaveCommand}" />
                <Separator />
                <MenuItem Header="Paste Transcript" Command="{Binding PasteCommand}" InputGestureText="Ctrl+V" />
            </MenuItem>
        </Menu>

        <!-- Shortcut Customization Bar -->
        <Popup x:Name="ShortcutPopup" StaysOpen="False" Placement="MousePoint" AllowsTransparency="True">
            <Border Style="{StaticResource ShortcutBarStyle}">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Press a key to set shortcut for " VerticalAlignment="Center" Margin="0,0,4,0" Foreground="#555555" />
                    <TextBlock x:Name="ShortcutActionText" FontWeight="SemiBold" VerticalAlignment="Center" Margin="0,0,12,0" />
                    <Border Background="#F0F0F0" Padding="8,2" CornerRadius="4">
                        <TextBlock x:Name="NewShortcutPreview" Text="..." FontWeight="Bold" Foreground="#4A90E2" />
                    </Border>
                    <Button Content="âœ•" Click="CloseShortcutPopup" BorderThickness="0" Background="Transparent" Foreground="#999999" Margin="12,0,0,0" Cursor="Hand" />
                </StackPanel>
            </Border>
        </Popup>
    </Grid>
    <Window.InputBindings>
        <KeyBinding Command="{Binding PasteCommand}" Gesture="Ctrl+V" />
        <KeyBinding Command="Undo" Gesture="Ctrl+Z" />
        <KeyBinding Command="Redo" Gesture="Ctrl+Y" />
    </Window.InputBindings>
</Window>

